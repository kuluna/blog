<!doctype html>
<html lang="ja">
<head>
  <title>kuluna.class</title>
  <meta name="description" content="Build any languages, Run anywhere.">
  <link rel="icon" href="https://kuluna.github.io/blog/favicon.ico">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
  <link rel="stylesheet" href="https://kuluna.github.io/blog/css/theme.css">
</head>
<body>
<header class="mdc-toolbar">
  <div class="mdc-toolbar__row">
    <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
      <a href="https://kuluna.github.io/blog/" class="title-link"><span class="mdc-toolbar__title">kuluna.class</span></a>
    </section>
  </div>
</header>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">

<main>
  <nav>
    <a href="https://kuluna.github.io/blog/" class="mdc-button" data-mdc-auto-init="MDCRipple">TOP</a>
  </nav>
  
  <article class="mdc-card mdc-elevation--z6 default-padding">
    <header>
      <h1 class="entry-title">ASP.NET Coreで常にHTTPSにリダイレクトする</h1>
      <span class="entry-date">2017-07-23 11:37:28 &#43;0900 JST</span>
    </header>
    
    <p>

<p>従来のASP.NETではweb.configをたくさんいじってあれこれ設定していましたが、ASP.NET CoreからはほとんどをStartup.csに記述するようなりました。<br />
個人的にもそのほうがコンパイルエラーで設定ミスとかが分かるのでこっちのほうが好きですね。</p>

<h1 id="環境">環境</h1>

<ul>
<li>.net core 1.1</li>
</ul>

<h1 id="httpsにリダイレクトする">HTTPSにリダイレクトする</h1>

<h2 id="rewriteのインストール">Rewriteのインストール</h2>

<p>HTTPでアクセスしたときにHTTPSへリダイレクトするのもStartup.csで設定するようになりました。</p>

<p>まずはNugetからリダイレクトするライブラリをインストールします。<br />
Nugetで<code>Microsoft.AspNetCore.Rewrite</code>を検索してインストールします。あるいはcsprojに直接書いてもOKです。</p>

<pre><code class="language-xml">&lt;ItemGroup&gt;
    &lt;PackageReference Include=&quot;Microsoft.AspNetCore.Rewrite&quot; Version=&quot;1.0.2&quot; /&gt;
&lt;/ItemGroup&gt;
</code></pre>

<p>csprojに直接書いた場合は<code>dotnet restore</code>コマンドを忘れずに実行しましょう。</p>

<h2 id="リダイレクト設定">リダイレクト設定</h2>

<p>Startup.csで編集する箇所は2か所です。</p>

<pre><code class="language-cs">public void ConfigureServices(IServiceCollection services)
{
    // Add framework services.
    services.AddMvc();
    
    services.Configure&lt;MvcOptions&gt;(options =&gt;
    {
        options.Filters.Add(new RequireHttpsAttribute());
    });
}
</code></pre>

<pre><code class="language-cs">public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    loggerFactory.AddConsole(Configuration.GetSection(&quot;Logging&quot;));
    loggerFactory.AddDebug();

    app.UseRewriter(new RewriteOptions().AddRedirectToHttps());

    app.UseMvc();
}
</code></pre>

<p>上ではASP.NET Core全体にHTTPSを必須とする属性を追加します。<br />
下ではHTTPでアクセスしたときにHTTPSでリダイレクトするように設定をしています。</p>

<p>Azure App ServicesではHTTPも受け付けますが、これでAzureにアップロードするとHTTPでアクセス時にHTTPSにリダイレクトされるようになります。</p>

<p><a href="https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?hl=ja">Googleのチェックツール</a>を使うとHTTPからHTTPSにリダイレクトできていることが検証できます。</p>

<p><img src="../../images/2017-07-23/1.png" alt="Lighthouse" /></p>

<h2 id="プロダクション時だけonにする">プロダクション時だけONにする</h2>

<p>Startup.csでは現在がどのモードで動作しているかが取得できるので、Production時だけの処理を簡単に書けます。</p>

<pre><code class="language-cs">if (env.IsProduction())
{
    app.UseRewriter(new RewriteOptions().AddRedirectToHttps());
}
</code></pre>

<p>またはappsettings.jsonの値を見るようにしても良いと思います。</p>

<h1 id="参考">参考</h1>

<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/enforcing-ssl">Enforcing SSL in an ASP.NET Core app</a></li>
</ul>
</p>

  </article>
  <nav>
    <a href="https://kuluna.github.io/blog/" class="mdc-button" data-mdc-auto-init="MDCRipple">TOP</a>
  </nav>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>window.mdc.autoInit();</script>
</body>
</html>

